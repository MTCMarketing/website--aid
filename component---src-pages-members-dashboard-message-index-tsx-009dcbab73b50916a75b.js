"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3910],{1713:function(e,t,n){n.r(t),n.d(t,{default:function(){return l}});var r=n(6540),o=n(5458),s=n(3),i=n(6898);const a=()=>{const{0:e,1:t}=(0,r.useState)(""),{0:n,1:a}=(0,r.useState)([]),{0:l,1:d}=(0,r.useState)([]),{0:c,1:u}=(0,r.useState)(!1),{0:g,1:p}=(0,r.useState)(null),m=(0,r.useRef)(null),f=(0,r.useRef)(null),v="6c77d859-1af1-418e-b0e0-0d3cc4e80fad";(0,r.useEffect)(()=>{i.ND.auth.getSession().then(e=>{var t,n,r;let{data:o}=e;const s=null!==(t=null===(n=o.session)||void 0===n||null===(r=n.user)||void 0===r?void 0:r.id)&&void 0!==t?t:null;console.log("ðŸ‘¤ User ID:",s),p(s)})},[]),(0,r.useEffect)(()=>{(async()=>{if(!g)return;console.log("ðŸ“¦ Fetching messages for:",g);const{data:e,error:t}=await i.ND.from("dm_messages").select("*").or(`sender_id.eq.${g},recipient_id.eq.${g}`).order("created_at",{ascending:!0});t?console.error("âŒ Fetch failed:",t.message):(console.log(`âœ… Loaded ${e.length} messages`),a(e))})()},[g]),(0,r.useEffect)(()=>{if(!g)return;console.log("ðŸ‘‚ Listening for realtime messages involving:",g);const e=i.ND.channel(`dm_stream_user_${g}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"dm_messages"},e=>{const t=e.new;t.sender_id!==g&&t.recipient_id!==g||(a(e=>{if(e.some(e=>e.id===t.id))return e;return[].concat((0,o.A)(e),[t]).sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime())}),setTimeout(()=>{var e;return null===(e=f.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},0))}).subscribe(e=>console.log("ðŸ“¡ Channel status:",e));return()=>{console.log("ðŸ§¹ Unsubscribing..."),i.ND.removeChannel(e)}},[g]),(0,r.useEffect)(()=>{var e;null===(e=f.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[n]);const b=async()=>{if(e.trim()&&g){u(!0);try{var n;const{data:r}=await i.ND.auth.getSession(),s=null==r||null===(n=r.session)||void 0===n?void 0:n.user;if(!s)throw new Error("Not logged in");console.log("ðŸ§¾ Insert payload:",{sender_id:s.id,message:e,recipient_id:v});const{data:l,error:c}=await i.ND.from("dm_messages").insert([{sender_id:s.id,message:e,recipient_id:v}]).select();c&&console.error("ðŸ”¥ Supabase insert error:",c),l&&l[0]&&(a(e=>[].concat((0,o.A)(e),[l[0]])),t(""),d([]),setTimeout(()=>{var e;return null===(e=f.current)||void 0===e?void 0:e.scrollIntoView({behavior:"smooth"})},0))}catch(r){console.error("âŒ Send failed:",r.message)}finally{u(!1)}}};return r.createElement("div",{style:{display:"flex",flexDirection:"column",height:"100vh",background:"#f9fafb",color:"#111827"}},r.createElement("div",{style:{background:"#e2e8f0",color:"#1e293b",fontSize:"12px",padding:"6px 12px",borderBottom:"1px solid #cbd5e1"}},"ðŸ‘¤ ",r.createElement("strong",null,"Current User ID:")," ",null!=g?g:"Loadingâ€¦ (no session yet)"),r.createElement("div",{style:{flexGrow:1,overflowY:"auto",padding:"20px",paddingBottom:"100px"}},n.map(e=>{const t=e.sender_id===g;return r.createElement("div",{key:e.id,style:{display:"flex",justifyContent:t?"flex-end":"flex-start",marginBottom:"10px"}},r.createElement("div",{style:{background:t?"#00838F":"#E2E8F0",color:t?"white":"#1E293B",borderRadius:"12px",padding:"10px 14px",maxWidth:"70%",wordBreak:"break-word"}},r.createElement("div",{style:{fontSize:"14px"}},e.message),r.createElement("div",{style:{fontSize:"11px",marginTop:"4px",opacity:.6,textAlign:t?"right":"left"}},new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))))}),r.createElement("div",{ref:f})),r.createElement("div",{style:{position:"sticky",bottom:0,background:"#fff",borderTop:"1px solid #e5e7eb",padding:"12px 20px",display:"flex",alignItems:"center",gap:"10px"}},r.createElement("button",{onClick:()=>{var e;return null===(e=m.current)||void 0===e?void 0:e.click()},style:{background:"none",border:"none",color:"#0369a1",cursor:"pointer"}},r.createElement(s._mV,{size:18})),r.createElement("input",{type:"file",ref:m,multiple:!0,onChange:e=>{if(e.target.files){const t=Array.from(e.target.files);d(e=>[].concat((0,o.A)(e),t))}},style:{display:"none"}}),r.createElement("input",{value:e,onChange:e=>t(e.target.value),placeholder:"Type your message...",style:{flexGrow:1,borderRadius:"8px",border:"1px solid #d1d5db",padding:"10px",fontSize:"14px"},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),b())}}),r.createElement("button",{onClick:b,disabled:c,style:{background:"#00838F",color:"white",border:"none",borderRadius:"8px",padding:"10px 14px",fontWeight:500,cursor:"pointer",opacity:c?.8:1,display:"flex",alignItems:"center",gap:"6px"}},r.createElement(s.kGk,{size:18}))))};var l=()=>r.createElement(a,null)}}]);
//# sourceMappingURL=component---src-pages-members-dashboard-message-index-tsx-009dcbab73b50916a75b.js.map